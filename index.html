<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
    <script src="js_libraries/modernizr.js"></script>
    <link rel="Stylesheet" type="text/css" href="fonts/dinofontstyles.css" />
    <link rel="Stylesheet" type="text/css" href="styles/dinostyles.css" />
    <title>Dino Defender</title>


</head>
<body>
<!--div id="game"-->
<div id="backgroundDiv">
<div id="gameScreen" class="screen">
<script src="loader.js"></script>
<script>
    var App = App || {};
    App.run = function (){

//=========================================================================
// Dino Defender!
// Dino Art courtesy of Wyverii, http://opengameart.org/content/unsealed-terrex
//texture tiles by  Jetrel, Daniel Cook, Bertram and Zabin,
// //http://opengameart.org/content/2d-lost-garden-tileset-transition-to-jetrels-wood-tileset
//UFO art by  dravenx,  http://opengameart.org/content/ufos-and-spaceship
//fireball "Iron Plague" art by Daniel Cook (Lostgarden.com)
//=========================================================================
//=========================================================================
// Draw Background
//==========================================================================

        app.drawBackgroundCanvas();
//=========================================================================
// Create Engine Instance
//=========================================================================
        var engineConfig = {
            imagePath: "images/",
            audioPath: "audio/",
            dataPath:  "data/"
        };

        var myEngine = Engine( engineConfig );
        myEngine.includeModule("Input, Sprites, Scenes, Animation");

//=========================================================================
// Setup Canvas
//=========================================================================
        var gameScreen = $("#gameScreen"),
                canvasH,
                canvasW;

        myEngine.setupCanvas( );
        myEngine.el.css('backgroundColor','#387FD1');
        canvasH = myEngine.el.height();
        canvasW = myEngine.el.width();

        $(myEngine.el).appendTo( gameScreen );

//=========================================================================
// Setup Input
//=========================================================================
        myEngine.input.enableMouse();
        myEngine.input.setKeyboardControls();

//=========================================================================
// Resources
//=========================================================================
        var AssetList = [
            "smoke.png",
            "smoke.json",
            "dino.png",
            "dino.json",
            "platformerSprites.png",
            "platformerSprites.json",
            "ufos.json","ufos.png",
            "textures.json","textures.png"

        ];

        var DinoAnimationGroupName = "dinoPlayer";
        var DinoAnimationSequences = {
            run_right: {
                frames: _.range(27,35),
                rate: 1/10
            },

            run_left: {
                frames: _.range(9,16),
                rate: 1/10
            },

            fire: {
                frames: _.range(18,26),
                next: 'stand',
                rate: 1/10
            },

            stand: {
                frames: [1],
                rate: 1/5
            },

            hop_up: {
                frames: _.range(20,23),
                rate: 1/5
            }
        };

        var SmokeAnimationGroupName = "smoke";
        var SmokeAnimationSequences = {
            explode: {
                frames: _.range(0,7),
                rate: 1/10,
                loop: false
            }
        };

        var UFOAnimationGroupName = "ufo";
        var UFOAnimationSequences = {
            fly: {
                frames: [0,1],
                rate: 1/10,
                loop: true
            },
            flame: {
                frames: _.range(0,3),
                rate: 1/10,
                loop: true
            }
        };


//=========================================================================
// Game Object - DinoClassPlayer
//=========================================================================
        var DinoClassPlayer = Engine.Sprite.extend({

            // name to help with debugging
            name: "DinoClassPlayer",
            fireOffset: 30,

            defaults: {
                // Sprite properties
                sheetName: "dino",
                animSetName: DinoAnimationGroupName,
                rate: 1/15,
                speed: 300,
                x: 100,
                y: canvasH - 100,
                hopDir: "up",
                hopping: false

            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "run_right" );

                // bind the input action event directly to trigger an animation
                myEngine.input.bindEvent('fire',this,"fire");

                //this.bindEvent('animEnd.fire',this,function() { console.log("Fired!"); });
                this.bindEvent('animLoop.run_right',this,function() { console.log("right"); });
                this.bindEvent('animLoop.run_left',this,function() { console.log("left"); });
                this.bindEvent('animLoop.hop_up',this,function() { console.log("hop"); });

                // poll for mouse status

               // this.bindEvent('step',this,'updateAngle');
               // myEngine.input.bindEvent('mouseleftup',this,'fire');
            },


            fire: function() {
                this.play('fire',1);



                var dir = this.transformLocalDirection(1, 0);

               /* var properties = {
                    x: this.properties.x + dir.x * this.fireOffset,
                    y: this.properties.y + dir.y * this.fireOffset,
                    angle: this.properties.angle
                }*/;

                pos = this.transformLocalPosition( 0, 100 );
                var newFireBall = new ClassFireBall( {
                    x: pos.x,
                    y: pos.y-150,
                    z:12
                } );
                myEngine.getStage().insert( newFireBall );

                //TODO need to fix, why can't it find .physics?
                // newFireBall.physics.setVelocity(dir.x*400,dir.y*400);
            },

            updateAngle: function() {
                var point = myEngine.input.mousePos;
                var angle = Math.atan2(point.y - this.properties.y, point.x - this.properties.x);
                this.properties.angle = angle;
            },

            step: function(dt) {
                var p = this.properties;
                if(p.animationName != 'fire') {

                    if(myEngine.inputs['right']) {
                        this.play('run_right');
                        //don't let dino run off the screen. need to get dino tileW dynamically
                        if(p.x < canvasW - 46)
                        {
                            p.x += p.speed * dt;
                        }
                    }
                   else if (myEngine.inputs['left']) {
                        this.play('run_left');
                        if(p.x > 46){
                            p.x -= p.speed * dt;
                     }
                    }
                    else if (myEngine.inputs['fart']) {
                        var pos = this.transformLocalPosition( 94, 0 );
                        var newEffect = new ClassExplosion( {x:pos.x, y:pos.y });
                        this.parentStage.insert( newEffect );

                    }
                   else if(myEngine.inputs['hop']) {

                        this.play('hop_up');
                        p.hopping = true;



                    } else {
                        this.play('stand');
                    }

                    //finish full hop because doesn't have time to complete within input loop
                    if(p.hopDir === "up" && p.hopping === true)
                    {
                        p.y -= p.speed * dt;
                        if(p.y < canvasH - 200){
                            p.hopDir = "down";
                        }
                    }
                    else if(p.hopDir === "down"&& p.hopping === true)
                    {
                        p.y += p.speed * dt;
                        if(p.y >= canvasH - 100 ){
                            p.y = canvasH - 100;
                            p.hopDir = "up";
                            p.hopping = false;
                        }
                    }
                }
                this._super(dt);
            }
        });
//=========================================================================
// FireBall Game Object
//=========================================================================
        var ClassFireBall = Engine.Sprite.extend({

            // Name to help with debugging
            name: "ClassFireBall",

            // extended properties for this class
            defaults: {
                // sprite properties
                sheetName: "fireball",
                animSetName: UFOAnimationGroupName,
                width: 25,	// physics circle radius * 2 (diameter)
                height: 25,	// physics circle radius * 2 (diameter)

                // physics properties
                shape: "circle",
                shape_radius: 12.5,
                restitution: 0.5,
                density: 4,
                bodyType: "dynamic",

                // gameplay properties
                seconds: 10		// lifetime before destroying self
            },

            init: function(props) {
                this._super(props);
                this.addComponent('animation');
                this.play( "flame" );
                this.addComponent('physics');
                this.bindEvent('step',this,'countdown');
            },

            countdown: function(dt) {
                this.properties.seconds -= dt;
                if(this.properties.seconds < 0) {
                    this.destroy();
                } else if(this.properties.seconds < 1) {
                    this.properties.alpha = this.properties.seconds;
                }
            }
        });
//=========================================================================
// Game Object - Explosion Effect
//=========================================================================
        var ClassExplosion = Engine.Sprite.extend({

            // name to help with debugging
            name: "ClassExplosion",

            defaults: {
                // Sprite properties
                sheetName: "smokeEffect",
                animSetName: SmokeAnimationGroupName,
                rate: 1/15,
                speed: 700,
                z: 20
            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "explode" );

                // Once the animation is done playing, destroy this object
                this.bindEvent('animEnd',this,function() {
                    this.destroy();
                });
            }

        });

//=========================================================================
// Game Object - BlueUFO
//=========================================================================
        var UFO = Engine.Sprite.extend({

            // name to help with debugging
            name: "UFO",

            defaults: {
                // Sprite properties
                sheetName: "blueUfo",
                animSetName: UFOAnimationGroupName,
                rate: 1/15,
                speed: 100,
                z: 20,
                scootDir: "right"
            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "fly" );

                // Once the animation is done playing, destroy this object
                //this.bindEvent('animFrame',this,function() {

                //});
            },

            step:function(dt) {
                //TODO figure out canvas offset property to get rid of magic number
                var p = this.properties;

                if(p.scootDir === "right")
                {
                    p.x += p.speed * dt;
                    if(p.x > canvasW - 46){
                        p.scootDir="left";
                    }
                }
                else if(p.scootDir === "left")
                {
                    p.x -= p.speed * dt;
                    if(p.x < 46){
                        p.scootDir="right";
                    }
                }
            }

        });

//=========================================================================
// Game Logic - Main Scene
//=========================================================================
        function generator(stage) {
            var newPlayer = new DinoClassPlayer( {z:10});
            stage.insert( newPlayer );

            var newUFO = new UFO( {
                x: 100,
                y: 100,
                z:11
            } );

            stage.insert( newUFO );




            //draw the ground
            var groundX = 88;

            for(var i= 0; i < 7; i++){
                stage.insert(new Engine.Sprite({ sheetName: "ground", x: groundX + (173*i), y: canvasH - 50}));
            }

            stage.insert(new Engine.Sprite({ sheetName: "house", x: (canvasW/2), y: canvasH - 150}));

            //stage.insert(new Engine.Sprite({ sheetName: "big_tree", x: 200, y: canvasH - 150}));
            //stage.addComponent( "camera" );
            //stage.camera.followEntity( newPlayer );

            //----------------
            // Input
            //----------------
            myEngine.input.bindEvent( "mouseleftdown", stage, function(mousePos) {
                mousePos = stage.transformLocalPosition( mousePos.x, mousePos.y );
                var newEffect = new ClassExplosion( {x:mousePos.x, y:mousePos.y });
                stage.insert( newEffect );
            });
        }

        var options = {
            sort: true
        };
        myEngine.addScene('level',new Engine.Scene(generator, options));


        myEngine.load(AssetList, function() {
            // Create a sprite sheet out of the loaded assets
            myEngine.compileSheets('dino.png','dino.json');
            myEngine.compileSheets('smoke.png','smoke.json');
            myEngine.compileSheets('platformerSprites.png','platformerSprites.json');
            myEngine.compileSheets('ufos.png','ufos.json');
            myEngine.compileSheets('textures.png','textures.json');

            // Assign animation data for sprites named 'player'
            myEngine.addAnimationData( DinoAnimationGroupName, DinoAnimationSequences );
            myEngine.addAnimationData( SmokeAnimationGroupName, SmokeAnimationSequences );
            myEngine.addAnimationData( UFOAnimationGroupName, UFOAnimationSequences );


            // Start the level
            myEngine.stageScene("level");

            // Setup level to loop
            myEngine.setGameLoop(function(dt) {
                myEngine.stageGameLoop(dt);
                //call ufomanager, spawn one every few secs

            });

        });

    }
</script>
</div>
</div>
<!--/div-->
</body>

</html>