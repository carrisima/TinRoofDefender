<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
    <script src="js_libraries/modernizr.js"></script>
    <link rel="Stylesheet" type="text/css" href="fonts/dinofontstyles.css" />
    <link rel="Stylesheet" type="text/css" href="styles/dinostyles.css" />
    <title>Dino Defender</title>


</head>
<body>
<!--div id="game"-->
<div id="backgroundDiv">
<div id="gameScreen" class="screen">
<script src="loader.js"></script>
<script>
    var App = App || {};
    App.run = function (){

//=========================================================================
// Dino Defender!
// Dino Art courtesy of Wyverii, http://opengameart.org/content/unsealed-terrex
//texture tiles by  Jetrel, Daniel Cook, Bertram and Zabin,
// //http://opengameart.org/content/2d-lost-garden-tileset-transition-to-jetrels-wood-tileset
//UFO art by  dravenx,  http://opengameart.org/content/ufos-and-spaceship
//=========================================================================
//=========================================================================
// Draw Background
//==========================================================================

        app.drawBackgroundCanvas();
//=========================================================================
// Create Engine Instance
//=========================================================================
        var engineConfig = {
            imagePath: "images/",
            audioPath: "audio/",
            dataPath:  "data/"
        };

        var myEngine = Engine( engineConfig );
        myEngine.includeModule("Input, Sprites, Scenes, Animation");

//=========================================================================
// Setup Canvas
//=========================================================================
        var gameScreen = $("#gameScreen"),
                canvasH,
                canvasW;

        myEngine.setupCanvas( );
        myEngine.el.css('backgroundColor','#387FD1');
        canvasH = myEngine.el.height();
        canvasW = myEngine.el.width();

        $(myEngine.el).appendTo( gameScreen );

//=========================================================================
// Setup Input
//=========================================================================
        myEngine.input.enableMouse();
        myEngine.input.setKeyboardControls();

//=========================================================================
// Resources
//=========================================================================
        var AssetList = [
            "smoke.png",
            "smoke.json",
            "dino.png",
            "dino.json",
            "platformerSprites.png",
            "platformerSprites.json",
            "ufos.json","ufos.png",
            "textures.json","textures.png"

        ];

        var DinoAnimationGroupName = "dinoPlayer";
        var DinoAnimationSequences = {
            run_right: {
                frames: _.range(27,35),
                rate: 1/10
            },

            run_left: {
                frames: _.range(9,16),
                rate: 1/10
            },

            fire: {
                frames: _.range(18,26),
                next: 'stand',
                rate: 1/10
            },

            stand: {
                frames: [1],
                rate: 1/5
            },

            hop_up: {
                frames: _.range(20,23),
                rate: 1/5
            }
        };

        var SmokeAnimationGroupName = "smoke";
        var SmokeAnimationSequences = {
            explode: {
                frames: _.range(0,7),
                rate: 1/10,
                loop: false
            }
        };

        var UFOAnimationGroupName = "ufo";
        var UFOAnimationSequences = {
            fly: {
                frames: _.range(0,2),
                rate: 1/10
            }
        };

//=========================================================================
// Game Object - DinoClassPlayer
//=========================================================================
        var DinoClassPlayer = Engine.Sprite.extend({

            // name to help with debugging
            name: "DinoClassPlayer",

            defaults: {
                // Sprite properties
                sheetName: "dino",
                animSetName: DinoAnimationGroupName,
                rate: 1/15,
                speed: 300,
                x: 100,
                y: canvasH - 100

            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "run_right" );

                // bind the input action event directly to trigger an animation
                myEngine.input.bindEvent('fire',this,"fire");

                this.bindEvent('animEnd.fire',this,function() { console.log("Fired!"); });
                this.bindEvent('animLoop.run_right',this,function() { console.log("right"); });
                this.bindEvent('animLoop.run_left',this,function() { console.log("left"); });
                this.bindEvent('animLoop.hop_up',this,function() { console.log("hop"); });
            },


            fire: function() {
                this.play('fire',1);

                var pos = this.transformLocalPosition( 94, 0 );
                var newEffect = new ClassExplosion( {x:pos.x, y:pos.y });
                this.parentStage.insert( newEffect );
            },

            step: function(dt) {
                var p = this.properties;
                if(p.animationName != 'fire') {

                    if(myEngine.inputs['right']) {
                        this.play('run_right');
                        //don't let dino run off the screen. need to get dino tileW dynamically
                        if(p.x < canvasW - 46)
                        {
                            p.x += p.speed * dt;
                        }
                    }
                    else if(myEngine.inputs['left']) {
                        this.play('run_left');
                        if(p.x > 46){
                            p.x -= p.speed * dt;
                     }
                    else if(myEngine.inputs['hop']) {
                            console.log("hop");
                            this.play('hop_up');
                            for( var y = 0; y < 40;y++ ){
                                p.y += y;
                            }

                        }

                    } else {
                        this.play('stand');
                    }
                }
                this._super(dt);
            }
        });

//=========================================================================
// Game Object - Explosion Effect
//=========================================================================
        var ClassExplosion = Engine.Sprite.extend({

            // name to help with debugging
            name: "ClassExplosion",

            defaults: {
                // Sprite properties
                sheetName: "smokeEffect",
                animSetName: SmokeAnimationGroupName,
                rate: 1/15,
                speed: 700,
                z: 20
            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "explode" );

                // Once the animation is done playing, destroy this object
                this.bindEvent('animEnd',this,function() {
                    this.destroy();
                });
            }

        });

//=========================================================================
// Game Object - BlueUFO
//=========================================================================
        var BlueUFO = Engine.Sprite.extend({

            // name to help with debugging
            name: "BlueUFO",

            defaults: {
                // Sprite properties
                sheetName: "blueUfo",
                animSetName: UFOAnimationGroupName,
                rate: 1/15,
                speed: 700,
                z: 20,
                x: 100,
                y: 100
            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "fly" );

                // Once the animation is done playing, destroy this object
                this.bindEvent('animEnd',this,function() {
                    this.destroy();
                });
            }

        });

//=========================================================================
// Game Logic - Main Scene
//=========================================================================
        function generator(stage) {
            var newPlayer = new DinoClassPlayer( {z:10} );
            stage.insert( newPlayer );

            var newBlueUFO = new BlueUFO( {z:11} );
            stage.insert( newBlueUFO );

            //draw the ground
            var groundX = 88;

            for(var i= 0; i < 7; i++){
                stage.insert(new Engine.Sprite({ sheetName: "ground", x: groundX + (173*i), y: canvasH - 50}));
            }

            stage.insert(new Engine.Sprite({ sheetName: "house", x: (canvasW/2), y: canvasH - 150}));
            //stage.insert(new Engine.Sprite({ sheetName: "big_tree", x: 200, y: canvasH - 150}));
            //stage.addComponent( "camera" );
            //stage.camera.followEntity( newPlayer );

            //----------------
            // Input
            //----------------
            myEngine.input.bindEvent( "mouseleftdown", stage, function(mousePos) {
                mousePos = stage.transformLocalPosition( mousePos.x, mousePos.y );
                var newEffect = new ClassExplosion( {x:mousePos.x, y:mousePos.y });
                stage.insert( newEffect );
            });
        }

        var options = {
            sort: true
        };
        myEngine.addScene('level',new Engine.Scene(generator, options));


        myEngine.load(AssetList, function() {
            // Create a sprite sheet out of the loaded assets
            myEngine.compileSheets('dino.png','dino.json');
            myEngine.compileSheets('smoke.png','smoke.json');
            myEngine.compileSheets('platformerSprites.png','platformerSprites.json');
            myEngine.compileSheets('ufos.png','ufos.json');
            myEngine.compileSheets('textures.png','textures.json');

            // Assign animation data for sprites named 'player'
            myEngine.addAnimationData( DinoAnimationGroupName, DinoAnimationSequences );
            myEngine.addAnimationData( SmokeAnimationGroupName, SmokeAnimationSequences );
            myEngine.addAnimationData( UFOAnimationGroupName, UFOAnimationGroupName );

            // Start the level
            myEngine.stageScene("level");

            // Setup level to loop
            myEngine.setGameLoop(function(dt) {
                myEngine.stageGameLoop(dt);
            });

        });

    }
</script>
</div>
</div>
<!--/div-->
</body>

</html>