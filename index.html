<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0"/>
    <script src="js_libraries/modernizr.js"></script>
    <link rel="Stylesheet" type="text/css" href="fonts/dinofontstyles.css" />
    <link rel="Stylesheet" type="text/css" href="styles/dinostyles.css" />
    <title>Dino Defender</title>


</head>
<body>
<div id="game">
<div id="backgroundDiv">
<script src="loader.js"></script>
<script>
    var App = App || {};
    App.run = function (){

//=========================================================================
// Dino Defender!
// Dino Art courtesy of Wyverii, http://opengameart.org/content/unsealed-terrex
//=========================================================================

//=========================================================================
// Create Engine Instance
//=========================================================================
        var engineConfig = {
            imagePath: "images/",
            audioPath: "audio/",
            dataPath:  "data/"
        };

        var myEngine = Engine( engineConfig );
        myEngine.includeModule("Input, Sprites, Scenes, Animation");

//=========================================================================
// Setup Canvas
//=========================================================================
        myEngine.setupCanvas( );
        myEngine.el.css('backgroundColor','blue');
        myEngine.el.css('position','absolute');


//=========================================================================
// Setup Input
//=========================================================================
        myEngine.input.enableMouse();
        myEngine.input.setKeyboardControls();

//=========================================================================
// Resources
//=========================================================================
        var AssetList = [
            "smoke.png",
            "smoke.json",
            "dino.png",
            "dino.json",
            "platformerSprites.png",
            "platformerSprites.json" // sprites data file
        ];

        var PlayerAnimationGroupName = "dinoPlayer";
        var PlayerAnimationSequences = {
            run_right: {
                frames: _.range(27,35),
                rate: 1/10
            },

            run_left: {
                frames: _.range(9,16),
                rate: 1/10
            },

            fire: {
                frames: _.range(18,26),
                next: 'stand',
                rate: 1/10
            },

            stand: {
                frames: [1],
                rate: 1/5
            }
        };

        var SmokeAnimationGroupName = "smoke";
        var SmokeAnimationSequences = {
            explode: {
                frames: _.range(0,7),
                rate: 1/10,
                loop: false
            }
        };

//=========================================================================
// Game Object - Player
//=========================================================================
        var ClassPlayer = Engine.Sprite.extend({

            // name to help with debugging
            name: "ClassPlayer",

            defaults: {
                // Sprite properties
                sheetName: "dino",
                animSetName: PlayerAnimationGroupName,
                rate: 1/15,
                speed: 100,
                x: 100,
                y:100

            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "run_right" );

                // bind the input action event directly to trigger an animation
                myEngine.input.bindEvent('fire',this,"fire");

                this.bindEvent('animEnd.fire',this,function() { console.log("Fired!"); });
                this.bindEvent('animLoop.run_right',this,function() { console.log("right"); });
                this.bindEvent('animLoop.run_left',this,function() { console.log("left"); });
            },


            fire: function() {
                this.play('fire',1);

                var pos = this.transformLocalPosition( 100, 0 );
                var newEffect = new ClassExplosion( {x:pos.x, y:pos.y });
                this.parentStage.insert( newEffect );
            },

            step: function(dt) {
                var p = this.properties;
                if(p.animationName != 'fire') {
                    if(myEngine.inputs['right']) {
                        this.play('run_right');
                        p.x += p.speed * dt;
                    } else if(myEngine.inputs['left']) {
                        this.play('run_left');
                        p.x -= p.speed * dt;
                    } else {
                        this.play('stand');
                    }
                }
                this._super(dt);
            }
        });

//=========================================================================
// Game Object - Explosion Effect
//=========================================================================
        var ClassExplosion = Engine.Sprite.extend({

            // name to help with debugging
            name: "ClassExplosion",

            defaults: {
                // Sprite properties
                sheetName: "smokeEffect",
                animSetName: SmokeAnimationGroupName,
                rate: 1/15,
                speed: 700,
                z: 20
            },

            init:function(props) {
                this._super(props);

                this.addComponent('animation');
                this.play( "explode" );

                // Once the animation is done playing, destroy this object
                this.bindEvent('animEnd',this,function() {
                    this.destroy();
                });
            }

        });
//=========================================================================
// Compile Platformer sheet
//=========================================================================
      //  myEngine.compileSheets('platformerSprites.png','platformerSprites.json');
//=========================================================================
// Game Logic - Main Scene
//=========================================================================
        function generator(stage) {
            var newPlayer = new ClassPlayer( {z:10} );
            stage.insert( newPlayer );


           stage.insert(new Engine.Sprite({ sheetName: "brick-border", x: -200, y: 0}));
           stage.insert(new Engine.Sprite({ sheetName: "brick", x: 200, y: 0 }));
           stage.insert(new Engine.Sprite({ sheetName: "wall", x: 600, y: 0 }));
           stage.insert(new Engine.Sprite({ sheetName: "woodbox", x: 1000, y: 0 }));

            //stage.addComponent( "camera" );
            //stage.camera.followEntity( newPlayer );

            //----------------
            // Input
            //----------------
            myEngine.input.bindEvent( "mouseleftdown", stage, function(mousePos) {
                mousePos = stage.transformLocalPosition( mousePos.x, mousePos.y );
                var newEffect = new ClassExplosion( {x:mousePos.x, y:mousePos.y });
                stage.insert( newEffect );
            });
        }

        var options = {
            sort: true
        };
        myEngine.addScene('level',new Engine.Scene(generator, options));


        myEngine.load(AssetList, function() {
            // Create a sprite sheet out of the loaded assets
            myEngine.compileSheets('dino.png','dino.json');
            myEngine.compileSheets('smoke.png','smoke.json');
            myEngine.compileSheets('platformerSprites.png','platformerSprites.json');

            // Assign animation data for sprites named 'player'
            myEngine.addAnimationData( PlayerAnimationGroupName, PlayerAnimationSequences );
            myEngine.addAnimationData( SmokeAnimationGroupName, SmokeAnimationSequences );

            // Start the level
            myEngine.stageScene("level");

            // Setup level to loop
            myEngine.setGameLoop(function(dt) {
                myEngine.stageGameLoop(dt);
            });

        });

    }
</script>
</div>
</div>
</body>

</html>